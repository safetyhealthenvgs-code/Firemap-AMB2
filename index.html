<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>แผนผังถังดับเพลิง</title>

<style>
body{font-family:sans-serif;padding:20px}
h2{text-align:center}

.filter{text-align:center;margin-bottom:10px}

.map-container{
  position:relative;
  width:800px;
  height:600px;
  background:url('Lay out AMB2.jpg') no-repeat;
  background-size:cover;
  border:1px solid #ccc;
  margin:auto
}

.marker{
  position:absolute;
  width:14px;height:14px;
  background:red;
  border:2px solid #fff;
  border-radius:50%;
  transform:translate(-50%,-50%);
  cursor:pointer
}

.marker:hover::after{
  content:attr(data-info);
  position:absolute;
  top:-60px;left:50%;
  transform:translateX(-50%);
  background:#000c;color:#fff;
  padding:6px 8px;
  border-radius:4px;
  font-size:12px;
  white-space:pre;
  z-index:10
}
</style>
</head>

<body>

<h2>แผนผังถังดับเพลิง Zone AMB2</h2>

<div class="filter">
  เลือกเดือน:
  <select id="monthFilter">
    <option value="">-- เลือกเดือน --</option>
  </select>
</div>

<div class="map-container" id="map"></div>

<script>
const SHEET_ID="18YbWGcRIHhxv40v_7NTXQUNL3mV9jnNQrjfcUOvQEQs";
const SHEET_NAME="Zone AMB2";

const DATE_COL=1;      // วันที่ตรวจ
const NAME_COL=2;      // ชื่อถัง
const XY_COL=11;       // พิกัด XY

const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;
let rows=[];

// แปลงปี พ.ศ.
function yearTH(y){ return y<2400 ? y+543 : y; }

// อ่านวันที่
function parseDate(c){
  if(!c) return null;
  if(c.v && typeof c.v==="string"){
    const m=c.v.match(/Date\((\d+),(\d+),(\d+)\)/);
    if(m) return {d:+m[3],m:+m[2]+1,y:+m[1]};
  }
  if(c.f){
    const p=c.f.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if(p) return {d:+p[1],m:+p[2],y:+p[3]};
  }
  return null;
}

// โหลดข้อมูล
fetch(url)
.then(r=>r.text())
.then(t=>{
  const json=JSON.parse(t.substring(47).slice(0,-2));
  rows=json.table.rows||[];
  buildDropdown();
});

// สร้าง Dropdown
function buildDropdown(){
  const set=new Set();
  rows.forEach(r=>{
    const d=parseDate(r.c[DATE_COL]);
    if(d) set.add(`${d.m}/${d.y}`);
  });

  const sel=document.getElementById("monthFilter");

  [...set].sort((a,b)=>{
    const [ma,ya]=a.split("/").map(Number);
    const [mb,yb]=b.split("/").map(Number);
    return yb-ya||mb-ma;
  }).forEach(v=>{
    const [m,y]=v.split("/").map(Number);
    const o=document.createElement("option");
    o.value=v;
    o.textContent=`${m}/${yearTH(y)}`;
    sel.appendChild(o);
  });

  if(sel.options.length>1){
    sel.selectedIndex=1;
    render(sel.value);
  }
  sel.onchange=()=>render(sel.value);
}

// วาด Marker
function render(month){
  const map=document.getElementById("map");
  map.innerHTML="";
  if(!month) return;

  rows.forEach(r=>{
    const d=parseDate(r.c[DATE_COL]);
    if(!d||`${d.m}/${d.y}`!==month) return;

    const xy=r.c[XY_COL]?.v;
    if(!xy||!xy.includes(",")) return;

    const [x,y]=xy.split(",").map(Number);
    if(isNaN(x)||isNaN(y)) return;

    const m=document.createElement("div");
    m.className="marker";
    m.style.left=`${x}%`;
    m.style.top=`${y}%`;
    m.setAttribute("data-info",
`วันที่ตรวจ: ${d.d}/${d.m}/${yearTH(d.y)}
ชื่อถัง: ${r.c[NAME_COL]?.v||""}`);

    map.appendChild(m);
  });
}
</script>

</body>
</html>
